<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>arthouse</title>
    <link rel="stylesheet" href="/css/landing.css" />
    <link rel="icon" type="image/png" href="images/logo.png" />
    <script defer src="/js/auth.js"></script>
    <script defer src="/js/header.js"></script>
  </head>
  <body>
    <main class="landing-wall">
      <div class="background-video">
        <video id="bgVideo" autoplay loop muted playsinline preload="auto">
          <source src="/images/landing_movies/loop.mp4" type="video/mp4" />
        </video>
      </div>

      <section class="landing-panel hero" aria-labelledby="hero-title">
        <h1 id="hero-title" class="hero-title">
          <span class="handwritten-1">Make art. Be seen.</span>
        </h1>
        <p class="hero-sub">
          Arthouse is a place for the next generation of filmmakers. Each piece
          is reviewed by experienced curators, so you don’t have to fight
          against algorithms or noise. Short film submissions are now open for
          Drop 001.
        </p>
        <nav class="hero-actions" aria-label="primary">
          <a class="cta invert" href="/auth/signup.html">Share your film →</a>
        </nav>
      </section>

      <script>
        // Header (kept from your pattern)
        fetch("/partials/header.html")
          .then((r) => r.text())
          .then((html) => {
            document.body.insertAdjacentHTML("afterbegin", html);
            window.authInit && window.authInit();
          })
          .catch(() => {});
      </script>
      <script>
        const sources = Array.from(
          { length: 15 },
          (_, i) => `/images/landing_movies/${i + 1}.mov`
        );

        const videoA = document.getElementById("bgVideoA");
        const videoB = document.getElementById("bgVideoB");

        let currentIndex = 0;
        let active = videoA; // the one currently visible
        let standby = videoB; // the one we preload next into
        let nextReady = false; // becomes true when standby is buffered
        let nextIndex = 1; // index of the clip being preloaded

        // Prepare the very first play + first preload
        function init() {
          active.src = sources[currentIndex];
          active.classList.add("active");
          active.play().catch(() => {});

          // Preload the next clip immediately
          queueNext();
          // When current ends, cut instantly to the preloaded standby
          active.onended = swapNow;
        }

        // Preload into the standby element while current plays
        function queueNext() {
          nextIndex = (currentIndex + 1) % sources.length;
          nextReady = false;

          // Clean up old listeners
          standby.onloadeddata = null;
          standby.oncanplaythrough = null;

          standby.src = sources[nextIndex];
          standby.load(); // start buffering

          // Mark ready as soon as we have first frame (more reliable than canplaythrough on Safari)
          standby.onloadeddata = () => {
            nextReady = true;
          };
          // Bonus: if browser fires canplaythrough, we’re definitely ready
          standby.oncanplaythrough = () => {
            nextReady = true;
          };
        }

        // Instant swap with no waiting
        function swapNow() {
          // If for some reason standby isn't ready, we still switch to avoid gaps
          // The browser will finish buffering and start as soon as it can.
          active.classList.remove("active");
          standby.classList.add("active");

          standby.currentTime = 0;
          standby.play().catch(() => {});

          // Swap references
          const wasActive = active;
          active = standby;
          standby = wasActive;

          currentIndex = nextIndex;

          // Hook up end event on the new active
          active.onended = swapNow;

          // Start preloading the next clip immediately
          queueNext();
        }

        init();
      </script>
    </main>
  </body>
</html>
